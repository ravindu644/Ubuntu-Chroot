name: Build and Release GUI and CLI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v3.1)'
        required: true
      update_jsons_only:
        description: 'Only update the JSONs and Changelog (skip build and release)'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    if: ${{ !inputs.update_jsons_only }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: GUI
            branch: gui
            suffix: -GUI
          - name: CLI
            branch: main
            suffix: -CLI
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0  # Fetch all history for proper tag comparison

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y rsync python3

      - name: Build Ubuntu RootFS
        run: |
          cd Docker
          VERSION="${{ github.event.inputs.version || github.ref_name }}" ./build.sh

      - name: Build Update ZIP
        run: ./build_zip.sh ${{ matrix.name }} "${{ github.event.inputs.version || github.ref_name }}" --update

      - name: Build Full ZIP
        run: ./build_zip.sh ${{ matrix.name }} "${{ github.event.inputs.version || github.ref_name }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-zip
          path: out/update${{ matrix.suffix }}.zip

      - name: Upload Full Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-full-zip
          path: out/Ubuntu-Chroot-${{ github.event.inputs.version || github.ref_name }}-*${{ matrix.suffix }}.zip

  release:
    if: ${{ !inputs.update_jsons_only }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./zips

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "./zips/**/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.event.inputs.version || github.ref_name }}
          name: "Ubuntu Chroot ${{ github.event.inputs.version || github.ref_name }}"
          draft: false
          prerelease: false

  update-json:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # Critical: fetch all history and tags
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'

      - name: Synchronize tags with remote
        run: |
          git fetch origin --prune --prune-tags --tags

      - name: Update JSONs and Changelog
        run: ./update_meta.sh
        env:
          VERSION: ${{ github.event.inputs.version || github.ref_name }}
          GITHUB_REF_NAME: ${{ github.event.inputs.version || github.ref_name }}

      - name: Commit and push changes
        run: |
          git add CHANGELOG.md update-*.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update metadata for ${{ github.event.inputs.version || github.ref_name }}"
            git push
          fi
