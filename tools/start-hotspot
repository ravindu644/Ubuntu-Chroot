#!/system/bin/sh
# THIS SCRIPT MUST BE RUN FROM A ROOT ANDROID SHELL
#
# Version 30: The Dual-Band Release
# - Allows the user to select between a 2.4GHz and a 5GHz hotspot.
# - Automatically enables 802.11ac (Wi-Fi 5) for 5GHz mode.
# - The definitive, feature-complete, polished script.

# --- Global Variables ---
DNS_SERVER1=$(getprop net.dns1)
[ -z "$DNS_SERVER1" ] && DNS_SERVER1=8.8.8.8
PHY_IFACE="wlan0"
AP_IFACE="ap0"
CHROOT_PATH="/data/local/ubuntu-chroot/rootfs"
HOLDER_PID_FILE="/data/local/ubuntu-chroot/holder.pid"

# Hotspot configuration variables (set via arguments or defaults)
UPSTREAM_IFACE=""
SSID=""
PASSWORD=""
BAND="2"
CHANNEL=""

# Network configuration constants
IP_GW="192.168.42.1"
IP_SUB_OCTET="255.255.255.0"
IP_SUB_CDIR="24"
IP_NET_ADDR="192.168.42.0"
IP_BEGIN="192.168.42.10"
IP_END="192.168.42.50"

SCRIPT_NAME="$(basename "$0")"

# --- Debug mode ---
LOGGING_ENABLED=${LOGGING_ENABLED:-0}

if [ "$LOGGING_ENABLED" -eq 1 ]; then
    LOG_DIR="${CHROOT_PATH%/*}/logs"
    mkdir -p "$LOG_DIR"
    LOG_FILE="$LOG_DIR/$SCRIPT_NAME.txt"
    LOG_FIFO="$LOG_DIR/$SCRIPT_NAME.fifo"
    rm -f "$LOG_FIFO" && mkfifo "$LOG_FIFO" 2>/dev/null
    echo "=== Logging started at $(date) ===" >> "$LOG_FILE"
    busybox tee -a "$LOG_FILE" < "$LOG_FIFO" &
    exec >> "$LOG_FIFO" 2>> "$LOG_FILE"
    set -x
fi

# --- Logging and Utility Functions ---

log() { echo "$1"; }
warn() { echo "[WARN] $1"; }
error() { echo "[ERROR] $1"; }

# --- Helper Function ---
_get_ns_flags() {
    # Central place to read and prepare namespace flags for nsenter.
    # This function now correctly translates long flags (--mount) to the
    # short flags (-m) that busybox nsenter requires.
    local flags_file="$HOLDER_PID_FILE.flags"
    if [ ! -f "$flags_file" ]; then
        echo "-m"; return # Fallback to mount only
    fi

    local long_flags short_flags
    long_flags=$(cat "$flags_file")

    if [ -z "$long_flags" ]; then
        echo "-m"; return
    fi

    for flag in $long_flags; do
        case "$flag" in
            --mount) short_flags="$short_flags -m" ;;
            --uts)   short_flags="$short_flags -u" ;;
            --ipc)   short_flags="$short_flags -i" ;;
            --net)   short_flags="$short_flags -n" ;;
            --pid)   short_flags="$short_flags -p" ;;
            # Ignore flags that nsenter doesn't need or support
            --cgroup|--fork) ;;
        esac
    done

    if [ -z "$short_flags" ]; then
        echo "-m"; return
    fi

    echo "$short_flags"
}

_execute_in_ns() {
    # Central execution function. Runs any given command inside the holder's namespaces.
    local holder_pid
    if [ -f "$HOLDER_PID_FILE" ] && kill -0 "$(cat "$HOLDER_PID_FILE")" 2>/dev/null; then
        holder_pid=$(cat "$HOLDER_PID_FILE")
        local ns_flags
        ns_flags=$(_get_ns_flags)

        busybox nsenter --target "$holder_pid" $ns_flags -- "$@"
    else
        # If no namespace holder is running, execute command directly.
        "$@"
    fi
}

run_in_ns() {
    # Wrapper to execute a command in the namespace but not yet in the chroot.
    # Primarily used for mounting filesystems.
    _execute_in_ns "$@"
}

run_in_chroot() {
    run_in_ns chroot "$CHROOT_PATH" /bin/bash -c "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; export TMPDIR=/tmp; $*"
}

check_prerequisites() {
    log "Checking prerequisites..."

    # Check Android commands
    if ! command -v /system/bin/ip >/dev/null 2>&1; then
        error "ip command not found at /system/bin/ip"
        return 1
    fi

    if ! command -v /system/bin/iptables >/dev/null 2>&1; then
        error "iptables command not found at /system/bin/iptables"
        return 1
    fi

    # Check chroot commands
    if ! run_in_chroot "command -v iw" >/dev/null 2>&1; then
        error "iw command not found in chroot"
        return 1
    fi

    if ! run_in_chroot "command -v hostapd" >/dev/null 2>&1; then
        error "hostapd not found in chroot. Please install hostapd."
        return 1
    fi

    if ! run_in_chroot "command -v dhcpd" >/dev/null 2>&1; then
        error "dhcpd not found in chroot. Please install isc-dhcp-server."
        return 1
    fi

    return 0
}

# --- Functions ---
function print_usage() {
    echo "Usage: sh start_wifi_hotspot.sh [-o <iface>] [-s <SSID>] [-p <password>] [-b <band>] [-c <channel>] [-k] [-h|--help]"
    echo "    -o <iface>     Upstream interface"
    echo "    -s <SSID>      Hotspot name"
    echo "    -p <password>  Hotspot password"
    echo "    -b <band>      Band selection (2 for 2.4GHz, 5 for 5GHz)"
    echo "    -c <channel>   Channel (1-11 for 2.4GHz, 36/48/149 etc for 5GHz)"
    echo "    -k             Kill hotspot"
    echo "    -h, --help     Show this help"
}

function kill_proc() {
    log "Bringing down $AP_IFACE and reverting settings..."

    # Stop services first
    run_in_chroot "pkill hostapd; pkill dhcpd" 2>/dev/null || true
    run_in_chroot "rm -f /var/lib/dhcp/dhcpd.leases /tmp/hotspot_dhcpd.conf /run/dhcpd.pid /tmp/hotspot_hostapd.conf /run/hostapd.pid" 2>/dev/null || true

    # Disable IP forwarding
    run_in_ns sh -c "echo 0 > /proc/sys/net/ipv4/ip_forward" 2>/dev/null || true

    # Remove iptables rules (in reverse order)
    run_in_ns /system/bin/iptables -t nat -D POSTROUTING -o $UPSTREAM_IFACE -j MASQUERADE 2>/dev/null || true
    run_in_ns /system/bin/iptables -t filter -D FORWARD -i $UPSTREAM_IFACE -o $AP_IFACE -j ACCEPT 2>/dev/null || true
    run_in_ns /system/bin/iptables -t filter -D FORWARD -i $AP_IFACE -o $UPSTREAM_IFACE -j ACCEPT 2>/dev/null || true
    run_in_ns /system/bin/ip rule del from all iif $AP_IFACE lookup $UPSTREAM_IFACE 2>/dev/null || true
    run_in_ns /system/bin/ip route del $IP_NET_ADDR/$IP_SUB_CDIR dev $AP_IFACE 2>/dev/null || true

    # Delete virtual interface
    run_in_chroot "iw dev $AP_IFACE del" 2>/dev/null || true

    log "Hotspot cleanup completed"
    exit 0
}

function config_network() {
    log "Creating virtual AP interface '$AP_IFACE'..."

    # Clean up any existing interface first
    run_in_chroot "iw dev $AP_IFACE del" 2>/dev/null || true

    # Create virtual interface
    if ! run_in_chroot "iw dev $PHY_IFACE interface add $AP_IFACE type __ap"; then
        error "Failed to create virtual AP interface $AP_IFACE"
        return 1
    fi

    # Verify interface was created
    if ! run_in_chroot "iw dev $AP_IFACE info" >/dev/null 2>&1; then
        error "Virtual interface $AP_IFACE was not created successfully"
        return 1
    fi

    log "Configuring hotspot IP address..."
    if ! run_in_ns /system/bin/ip link set $AP_IFACE down; then
        error "Failed to bring down interface $AP_IFACE"
        return 1
    fi

    if ! run_in_ns /system/bin/ip addr flush dev $AP_IFACE; then
        error "Failed to flush addresses on $AP_IFACE"
        return 1
    fi

    if ! run_in_ns /system/bin/ip addr add $IP_GW/$IP_SUB_CDIR dev $AP_IFACE; then
        error "Failed to assign IP address $IP_GW/$IP_SUB_CDIR to $AP_IFACE"
        return 1
    fi

    if ! run_in_ns /system/bin/ip link set $AP_IFACE up; then
        error "Failed to bring up interface $AP_IFACE"
        return 1
    fi

    # Verify IP address was assigned
    if ! run_in_ns /system/bin/ip addr show dev $AP_IFACE | grep -q "$IP_GW"; then
        error "IP address $IP_GW was not assigned to $AP_IFACE"
        return 1
    fi

    log "Enabling Kernel IP forwarding..."
    if ! run_in_ns sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"; then
        error "Failed to enable IP forwarding"
        return 1
    fi

    # Verify IP forwarding is enabled
    if [ "$(run_in_ns cat /proc/sys/net/ipv4/ip_forward)" != "1" ]; then
        error "IP forwarding was not enabled"
        return 1
    fi

    log "Adding routing and firewall rules..."

    # Get main routing table ID
    MAIN_TABLE=$(run_in_ns /system/bin/ip rule list | head -n1 | sed -n -e 's/^.*lookup \(.*\)$/\1/p')
    if [ -z "$MAIN_TABLE" ]; then
        error "Could not determine main routing table"
        return 1
    fi

    log "Adding explicit route for hotspot subnet to main table ($MAIN_TABLE)..."
    if ! run_in_ns /system/bin/ip route append $IP_NET_ADDR/$IP_SUB_CDIR dev $AP_IFACE src $IP_GW proto kernel scope link table $MAIN_TABLE; then
        error "Failed to add route to main table"
        return 1
    fi

    # Add policy routing rule
    if ! run_in_ns /system/bin/ip rule add from all iif $AP_IFACE lookup $UPSTREAM_IFACE; then
        error "Failed to add policy routing rule"
        return 1
    fi

    # Add iptables rules
    if ! run_in_ns /system/bin/iptables -t filter -I FORWARD 1 -i $AP_IFACE -o $UPSTREAM_IFACE -j ACCEPT; then
        error "Failed to add FORWARD rule 1"
        return 1
    fi

    if ! run_in_ns /system/bin/iptables -t filter -I FORWARD 2 -i $UPSTREAM_IFACE -o $AP_IFACE -j ACCEPT; then
        error "Failed to add FORWARD rule 2"
        return 1
    fi

    if ! run_in_ns /system/bin/iptables -t nat -I POSTROUTING 1 -o $UPSTREAM_IFACE -j MASQUERADE; then
        error "Failed to add NAT MASQUERADE rule"
        return 1
    fi

    log "Network configuration completed successfully"
    return 0
}

function start_services() {
    log "Creating configuration files in chroot..."

    # --- Smart Config Generation ---
    if [ "$BAND" = "5" ]; then
        # 5GHz Configuration with 802.11ac
        HOSTAPD_CONF="interface=$AP_IFACE
driver=nl80211
ssid=$SSID
hw_mode=a
channel=$CHANNEL
ieee80211n=1
ieee80211ac=1
wpa=2
wpa_passphrase=$PASSWORD
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP"
    else
        # 2.4GHz Configuration (Default)
        HOSTAPD_CONF="interface=$AP_IFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=$CHANNEL
wpa=2
wpa_passphrase=$PASSWORD
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP"
    fi

    # Create hostapd config file
    if ! run_in_chroot "echo \"$HOSTAPD_CONF\" > /tmp/hotspot_hostapd.conf"; then
        error "Failed to create hostapd configuration file"
        return 1
    fi

    # Verify hostapd config file was created
    if ! run_in_chroot "test -f /tmp/hotspot_hostapd.conf"; then
        error "Hostapd configuration file was not created"
        return 1
    fi

    # Create DHCP config file
    DHCP_CONF="ddns-update-style none;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;
subnet $IP_NET_ADDR netmask $IP_SUB_OCTET {
  range $IP_BEGIN $IP_END;
  option routers $IP_GW;
  option domain-name-servers $DNS_SERVER1, 8.8.8.8;
}"

    if ! run_in_chroot "cat << EOF > /tmp/hotspot_dhcpd.conf
$DHCP_CONF
EOF"; then
        error "Failed to create DHCP configuration file"
        return 1
    fi

    # Verify DHCP config file was created
    if ! run_in_chroot "test -f /tmp/hotspot_dhcpd.conf"; then
        error "DHCP configuration file was not created"
        return 1
    fi

    log "Starting hostapd and isc-dhcp-server in chroot..."

    # Prepare DHCP lease file
    if ! run_in_chroot "rm -f /var/lib/dhcp/dhcpd.leases && touch /var/lib/dhcp/dhcpd.leases"; then
        error "Failed to prepare DHCP lease file"
        return 1
    fi

    # Start hostapd in background
    if ! run_in_chroot "/usr/sbin/hostapd -B -P /run/hostapd.pid /tmp/hotspot_hostapd.conf"; then
        error "Failed to start hostapd"
        return 1
    fi

    # Wait a moment for hostapd to start
    sleep 2

    # Verify hostapd is running
    if ! run_in_chroot "test -f /run/hostapd.pid && kill -0 \$(cat /run/hostapd.pid) 2>/dev/null"; then
        error "Hostapd failed to start or is not running"
        return 1
    fi

    log "Hostapd started successfully (PID: $(run_in_chroot "cat /run/hostapd.pid"))"

    # Start dhcpd in background
    if ! run_in_chroot "/usr/sbin/dhcpd -cf /tmp/hotspot_dhcpd.conf -q $AP_IFACE"; then
        error "Failed to start dhcpd"
        # Don't return here - dhcpd might start successfully despite warnings
        warn "dhcpd may have started with warnings"
    fi

    # Wait a moment for dhcpd to start
    sleep 2

    # Verify dhcpd is running
    if ! run_in_chroot "test -f /run/dhcpd.pid && kill -0 \$(cat /run/dhcpd.pid) 2>/dev/null"; then
        error "dhcpd failed to start or is not running"
        return 1
    fi

    log "DHCP server started successfully (PID: $(run_in_chroot "cat /run/dhcpd.pid"))"

    log "All services started successfully"
    return 0
}

# --- Command Line Argument Processing ---
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            print_usage
            exit 0
            ;;
        -k)
            # Load holder PID for namespace isolation
            if [ -f "$HOLDER_PID_FILE" ]; then
                HOLDER_PID=$(cat "$HOLDER_PID_FILE")
            fi
            # Set dummy variables to avoid errors in kill_proc
            UPSTREAM_IFACE=""
            IP_NET_ADDR="192.168.42.0"
            IP_SUB_CDIR="24"
            kill_proc
            shift
            ;;
        -o)
            shift
            UPSTREAM_IFACE="$1"
            shift
            ;;
        -s)
            shift
            SSID=""
            while [ $# -gt 0 ]; do
                case "$1" in
                    -o|-p|-b|-c|-k|-h|--help) break ;;
                    *) SSID="$SSID${SSID:+ }$1"; shift ;;
                esac
            done
            ;;
        -p)
            shift
            PASSWORD="$1"
            shift
            ;;
        -b)
            shift
            BAND="$1"
            shift
            ;;
        -c)
            shift
            CHANNEL="$1"
            shift
            ;;
        *)
            error "Unknown option: $1"
            print_usage
            exit 1
            ;;
    esac
done

# --- Main Part ---
trap 'kill_proc; exit' INT TERM

# --- Interactive Mode ---
if [ -z "$UPSTREAM_IFACE" ]; then
    if [ "$SILENT" -eq 0 ]; then
        echo -n "Enter Internet Interface (e.g., wlan0): "
        read UPSTREAM_IFACE
    else
        error "Upstream interface not specified"
        exit 1
    fi
fi

if [ -z "$SSID" ]; then
    if [ "$SILENT" -eq 0 ]; then
        echo -n "Enter Hotspot Name (SSID): "
        read SSID
    else
        error "SSID not specified"
        exit 1
    fi
fi

if [ -z "$PASSWORD" ]; then
    if [ "$SILENT" -eq 0 ]; then
        echo -n "Enter Hotspot Password (min 8 chars): "
        read PASSWORD
    else
        error "Password not specified"
        exit 1
    fi
fi

if [ -z "$BAND" ]; then
    BAND=2
fi

if [ -z "$CHANNEL" ]; then
    if [ "$BAND" = "5" ]; then
        CHANNEL=36
    else
        CHANNEL=6
    fi
fi

# Final validation
[ -z "$UPSTREAM_IFACE" ] && error "Upstream interface cannot be empty." && exit 1
[ -z "$SSID" ] && error "SSID cannot be empty." && exit 1
if [ $(echo -n "$PASSWORD" | wc -c) -lt 8 ]; then
    error "Password must be at least 8 characters long."
    exit 1
fi
[ -z "$CHANNEL" ] && error "Channel cannot be empty." && exit 1

# Load holder PID for namespace isolation
if [ -f "$HOLDER_PID_FILE" ]; then
    HOLDER_PID=$(cat "$HOLDER_PID_FILE")
fi

log "Starting hotspot setup process..."

# Step 1: Check prerequisites
if ! check_prerequisites; then
    error "Prerequisites check failed"
    exit 1
fi

# Step 2: Configure network
if ! config_network; then
    error "Network configuration failed"
    # Try to clean up on failure
    run_in_chroot "iw dev $AP_IFACE del" 2>/dev/null || true
    exit 1
fi

# Step 3: Start services
if ! start_services; then
    error "Service startup failed"
    # Try to clean up on failure
    run_in_chroot "pkill hostapd; pkill dhcpd" 2>/dev/null || true
    run_in_chroot "rm -f /tmp/hotspot_hostapd.conf /tmp/hotspot_dhcpd.conf /run/hostapd.pid /run/dhcpd.pid" 2>/dev/null || true
    run_in_chroot "iw dev $AP_IFACE del" 2>/dev/null || true
    exit 1
fi

log "Hotspot is now ACTIVE!"
log "Gateway IP: $IP_GW"
log "Network: $IP_NET_ADDR/$IP_SUB_CDIR"
exit 0
